<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Creazioni D'Arte Eleonora ‚Äì Catalogo</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#fdf5f9;
  --bg2:#f3e7ff;
  --accent1:#f7d1e0;
  --accent2:#c9b7ff;
  --text:#3b3b3b;
}
*{box-sizing:border-box;transition:all .25s ease}
html,body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  padding:16px;
  touch-action:manipulation;
  overscroll-behavior:none;
}
.wrap{max-width:1100px;margin:auto;animation:fadein .6s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
header{display:flex;align-items:center;gap:16px;margin-bottom:20px;}
.logo-preview{
  width:88px;height:88px;border-radius:16px;overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
  display:flex;align-items:center;justify-content:center;
  background:#f7f3ff;color:#aaa;font-weight:600;font-size:14px;
  opacity:0;transform:scale(0.9);
}
.logo-preview.show{
  animation:logoEnter .8s ease forwards;
}
@keyframes logoEnter{
  from{opacity:0;transform:scale(0.8) rotate(-3deg);}
  to{opacity:1;transform:scale(1) rotate(0);}
}
.logo-preview img{width:100%;height:100%;object-fit:contain;}
.title{font-family:'Dancing Script',cursive;font-size:30px;color:#7a3b6f;}
.subtitle{color:#6b6b6b;font-size:13px;}
.btn{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,var(--accent2),var(--accent1));
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn:hover{box-shadow:0 0 10px rgba(247,209,224,0.8);}
.btn-ghost{
  padding:8px 14px;border-radius:12px;border:1px dashed rgba(0,0,0,0.1);
  background:#fff;cursor:pointer;
}
.btn-import{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,#90EE90,#32CD32);
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn-import:hover{box-shadow:0 0 10px rgba(144,238,144,0.8);}
.btn-export{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,#FFD700,#FFA500);
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn-export:hover{box-shadow:0 0 10px rgba(255,215,0,0.8);}
.panel{
  background:#fff;border-radius:16px;padding:14px;margin-bottom:14px;
  box-shadow:0 4px 18px rgba(0,0,0,0.08);
}
.main{margin-top:10px;}
.section{
  margin-bottom:10px;border-radius:16px;overflow:hidden;
  border:1px solid rgba(0,0,0,0.06);
  background:#fff;
}
.section.dragging{opacity:0.6;}
.section .head{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 14px;background:linear-gradient(90deg,rgba(201,183,255,0.12),rgba(247,209,224,0.12));
  cursor:grab;
}
.section .head h3{
  margin:0;font-family:'Dancing Script',cursive;font-size:20px;color:#7a3b6f;display:flex;align-items:center;gap:8px;
}
.section .head button.del{background:none;border:none;color:#c64d6f;cursor:pointer;font-size:18px;}
.cards{
  padding:14px;display:none;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:12px;background:#fff;
}
.section.open .cards{display:grid;animation:fadecards .3s ease;}
@keyframes fadecards{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}
.card{
  background:#fff;border-radius:12px;padding:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  display:flex;flex-direction:column;gap:8px;
}
.card:hover{box-shadow:0 0 8px rgba(255,175,200,0.5);}
.thumb{width:100%;height:200px;border-radius:10px;overflow:hidden;background:#fafafa;display:flex;align-items:center;justify-content:center;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.code{font-weight:700;color:#c64d6f;font-size:14px;}
.note{font-size:13px;color:#6b6b6b;}
.controls{display:flex;gap:8px;align-items:center;justify-content:space-between;}
.qty{width:60px;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center;}
.fav{display:flex;align-items:center;gap:5px;}
.import-export-section{
  background:#fff3cd;
  border:2px dashed #ffc107;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.import-export-section h4{
  margin:0 0 10px 0;
  color:#856404;
  font-family:'Dancing Script',cursive;
  font-size:20px;
}
.button-group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo-preview" id="logoBox"><span>Logo</span><img id="logoImg" alt="logo" style="display:none;"></div>
  <div>
    <div class="title">Creazioni D'Arte Eleonora</div>
    <div class="subtitle">Catalogo Lavori Personalizzati</div>
  </div>
</header>

<script>
window.addEventListener("DOMContentLoaded",()=>{
  const logoBox=document.getElementById("logoBox");
  requestAnimationFrame(()=>logoBox.classList.add("show"));
});
</script>

<div class="import-export-section">
  <h4>üíæ Import/Export Database</h4>
  <div style="font-size:13px;color:#856404;margin-bottom:10px;">
    Esporta tutto il database (foto incluse) per trasferirlo su altri dispositivi o come backup.
  </div>
  <div class="button-group">
    <button class="btn-export" id="exportDatabase">üì¶ Esporta Database (.json)</button>
    <label class="btn-import">
      üì• Importa Database
      <input id="importDatabase" type="file" accept=".json,application/json" style="display:none;">
    </label>
  </div>
</div>

<div class="panel">
  <label class="btn">Carica logo<input id="logoInput" type="file" accept="image/*" style="display:none;"></label>
  <input id="newSectionName" placeholder="Nuova sezione (es. Natale)" style="padding:8px;border-radius:8px;border:1px solid #ccc;margin:6px 0;width:60%">
  <button class="btn" id="addSectionBtn">Aggiungi sezione</button>
  <button class="btn-ghost" id="resetStorage">üîÑ Reset catalogo</button>
</div>

<div class="panel">
  <input id="emailDest" placeholder="Email destinatario ordini" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:6px;">
  <button class="btn-ghost" id="exportHtml">üíæ Esporta catalogo (.html)</button>
  <div style="margin-top:8px;font-weight:600;color:#7a3b6f;">Totale lavori: <span id="totaleLavori">0</span></div>
</div>

<main class="main" id="mainContent"></main>
</div>
<script>
let sections=[],logoData=null;
const main=document.getElementById('mainContent');

function uid(p='id'){return p+'_'+Math.floor(Math.random()*1e9).toString(36);}

function save(){
  localStorage.setItem('eleonora_sections',JSON.stringify(sections));
  localStorage.setItem('eleonora_logo',logoData||'');
  localStorage.setItem('eleonora_email',document.getElementById('emailDest').value);
}

function load(){
  const s=localStorage.getItem('eleonora_sections'),
        l=localStorage.getItem('eleonora_logo'),
        e=localStorage.getItem('eleonora_email');
  if(s)sections=JSON.parse(s);
  // ‚õî MODIFICA: Inizializza a [] se non trova nulla per permettere l'esportazione di un database vuoto.
  else sections=[]; 
  
  if(l){
    logoData=l;
    document.getElementById('logoImg').src=l;
    document.getElementById('logoImg').style.display='block';
    document.querySelector('#logoBox span').style.display='none';
  }
  if(e)document.getElementById('emailDest').value=e;
  
  // Aggiunge la sezione di default 'Natale' solo se non ci sono sezioni e non c'√® nulla in localStorage
  if(!s && sections.length === 0) {
    sections.push({id:uid('sec'),name:'Natale',items:[]});
  }
}

function updateTotal(){
  let t=0;
  sections.forEach(s=>t+=s.items.length);
  document.getElementById('totaleLavori').textContent=t;
}

function nextCode(){
  let max=0;
  sections.forEach(s=>s.items.forEach(i=>{
    const m=i.code.match(/LAV0*([0-9]+)/);
    if(m){
      const n=+m[1];
      if(n>max)max=n;
    }
  }));
  return max+1;
}

function addPhoto(sec){
  const inp=document.createElement('input');
  inp.type='file';inp.multiple=true;inp.accept='image/*';
  inp.onchange=e=>{
    const files=Array.from(e.target.files);
    files.forEach(file=>{
      const r=new FileReader();
      r.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          const max=800;let w=img.width,h=img.height;
          if(w>h&&w>max){h=h*max/w;w=max;}
          else if(h>max){w=w*max/h;h=max;}
          const c=document.createElement('canvas');
          c.width=w;c.height=h;
          const ctx=c.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          const data=c.toDataURL('image/jpeg',0.8);
          sec.items.push({
            id:uid('it'),
            img:data,
            code:'LAV'+String(nextCode()).padStart(3,'0'),
            note:'',
            qty:0,
            fav:false
          });
          save();render();
        };
        img.src=ev.target.result;
      };
      r.readAsDataURL(file);
    });
  };
  inp.click();
}

function render(){
  main.innerHTML='';
  sections.forEach(sec=>{
    const s=document.createElement('div');s.className='section';s.draggable=true;
    s.innerHTML=`
      <div class="head">
        <h3>${sec.name} <button class="del" title="Elimina sezione">üóëÔ∏è</button></h3>
        <span>‚ñº</span>
        <button class="btn-ghost" data-id="${sec.id}">Aggiungi foto</button>
      </div>
      <div class="cards"></div>`;
    const grid=s.querySelector('.cards');

    sec.items.forEach(it=>{
      const c=document.createElement('div');
      c.className='card';
      c.innerHTML=`
        <div class="thumb"><img src="${it.img}"></div>
        <div class="code">${it.code}</div>
        <div class="note" contenteditable="true">${it.note||'Nota...'}</div>
        <div class="controls">
          <label class="fav"><input type="checkbox" ${it.fav?'checked':''}> üíï</label>
          <input type="number" value="${it.qty}" min="0" class="qty">
        </div>
        <button class="btn-ghost del-photo">üóëÔ∏è Elimina foto</button>
      `;
      grid.appendChild(c);

      c.querySelector('.note').oninput=e=>{it.note=e.target.textContent;save();};
      c.querySelector('input[type=checkbox]').onchange=e=>{it.fav=e.target.checked;save();};
      c.querySelector('.qty').onchange=e=>{it.qty=parseInt(e.target.value)||0;save();};

      c.querySelector('.del-photo').onclick=()=>{
        if(confirm('Vuoi eliminare questa foto?')){
          sec.items = sec.items.filter(x=>x.id!==it.id);
          save();render();
        }
      };
    });

    s.querySelector('.head').addEventListener('click',e=>{
      if(e.target.tagName==='BUTTON' && !e.target.classList.contains('del'))return;
      s.classList.toggle('open');
    });

    s.querySelector('.btn-ghost').onclick=()=>addPhoto(sec);

    s.querySelector('.del').onclick=()=>{
      if(confirm('Vuoi eliminare la sezione "'+sec.name+'"?')){
        sections=sections.filter(x=>x.id!==sec.id);
        save();render();
      }
    };

    s.addEventListener('dragstart',()=>s.classList.add('dragging'));
    s.addEventListener('dragend',()=>{s.classList.remove('dragging');save();});
    main.appendChild(s);
  });

  updateTotal();save();
  enableDrag();
}
function enableDrag(){
  main.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=document.querySelector('.dragging');
    const after=getDragAfterElement(main,e.clientY);
    if(after==null) main.appendChild(dragging); 
    else main.insertBefore(dragging,after);
    sections=[...main.querySelectorAll('.section')].map(s=>{
      const id=s.querySelector('.btn-ghost').dataset.id;
      return sections.find(x=>x.id===id);
    });
    save();
  });
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.section:not(.dragging)')];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset){
      return {offset:offset,element:child};
    } else return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}

// üÜï ESPORTA DATABASE
document.getElementById('exportDatabase').onclick=()=>{
  const database = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    logo: logoData,
    email: document.getElementById('emailDest').value,
    sections: sections
  };
  
  const dataStr = JSON.stringify(database, null, 2);
  const filename = `catalogo_eleonora_${new Date().toISOString().split('T')[0]}.json`;
  
  // üü¢ MODIFICA: Utilizzo della tecnica data-uri, pi√π affidabile per i download su mobile.
  const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
  
  const a = document.createElement('a');
  a.href = dataUri;
  a.download = filename;
  
  // Inserisce, clicca e rimuove l'elemento per forzare il download.
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  alert('‚úÖ Database esportato e scaricato! Cercalo nella cartella "Download" e condividilo da l√¨ per il trasferimento.');
};

// üÜï IMPORTA DATABASE
document.getElementById('importDatabase').onchange=e=>{
  const file = e.target.files[0];
  if(!file) return;
  
  if(!confirm('‚ö†Ô∏è ATTENZIONE: L\'importazione sostituir√† tutti i dati attuali. Continuare?')) {
    e.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const database = JSON.parse(ev.target.result);
      
      // Validazione base
      if(!database.sections || !Array.isArray(database.sections)) {
        throw new Error('File non valido: manca la struttura sezioni o non √® un formato array.');
      }
      
      // Importa tutto
      sections = database.sections;
      logoData = database.logo || null;
      
      // Aggiorna logo
      if(logoData) {
        document.getElementById('logoImg').src = logoData;
        document.getElementById('logoImg').style.display = 'block';
        document.querySelector('#logoBox span').style.display = 'none';
      } else {
        document.getElementById('logoImg').style.display = 'none';
        document.querySelector('#logoBox span').style.display = 'block';
      }
      
      // Aggiorna email
      if(database.email) {
        document.getElementById('emailDest').value = database.email;
      }
      
      // Salva e renderizza
      save();
      render();
      
      alert('‚úÖ Database importato con successo!\n\n' + 
            `üì¶ Sezioni: ${sections.length}\n` +
            `üì∏ Foto totali: ${sections.reduce((tot,s)=>tot+s.items.length,0)}\n` +
            `üìÖ Esportato il: ${new Date(database.exportDate).toLocaleDateString('it-IT')}`);
      
    } catch(err) {
      alert('‚ùå Errore durante l\'importazione:\n' + err.message);
      console.error(err);
    }
    
    e.target.value = '';
  };
  
  reader.readAsText(file);
};

document.getElementById('addSectionBtn').onclick=()=>{
  const n=document.getElementById('newSectionName').value.trim();
  if(!n)return alert('Scrivi un nome sezione!');
  sections.push({id:uid('sec'),name:n,items:[]});
  document.getElementById('newSectionName').value='';
  save();render();
};
document.getElementById('newSectionName').addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('addSectionBtn').click();
  }
});
document.getElementById('logoInput').onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=a=>{
    logoData=a.target.result;
    const img=document.getElementById('logoImg');
    img.src=logoData;
    img.style.display='block';
    document.querySelector('#logoBox span').style.display='none';
    save();
  };
  r.readAsDataURL(f);
};

document.getElementById('resetStorage').onclick=()=>{
  if(confirm('Eliminare tutto?')){
    localStorage.clear();
    location.reload();
  }
};

document.getElementById('exportHtml').onclick=()=>{
  const email=document.getElementById('emailDest').value||'';
  const clienteHtml=`<!DOCTYPE html><html lang="it"><head><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Catalogo Cliente</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,Arial;background:linear-gradient(135deg,#fdf5f9,#f3e7ff);color:#333;padding:10px;overflow-x:hidden;overflow-y:auto;}
    section{border:1px solid #eee;border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,0.05);}
    .head{background:rgba(201,183,255,0.15);padding:8px;display:flex;justify-content:space-between;cursor:pointer;}
    .cards{display:none;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;padding:10px;}
    section.open .cards{display:grid;}
    img{max-width:100%;border-radius:10px;}
    .btn{padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(135deg,#c9b7ff,#f7d1e0);color:#fff;font-weight:600;cursor:pointer;display:block;margin:10px auto;}
    .logoBox{width:120px;height:120px;margin:0 auto 10px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:#f7f3ff;}
    .logoBox img{max-width:100%;max-height:100%;object-fit:contain;}

     /* üëá ANIMAZIONE INTRO LOGO */
    #intro{
      position:fixed;inset:0;
      background:linear-gradient(135deg,#fdf5f9,#f3e7ff);
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;z-index:9999;
      animation:fadeOut 1s ease 2.5s forwards;
    }
    #intro img{
      width:280px;
      height:280px;
      object-fit:contain;
      opacity:0;
      animation:logoIn 1.2s ease forwards;
    }
    @keyframes logoIn{
      0%{opacity:0;transform:scale(0.8);}
      100%{opacity:1;transform:scale(1);}
    }
    @keyframes fadeOut{
      to{opacity:0;visibility:hidden;}
    }
    #content{opacity:0;animation:showContent 1s ease 2.5s forwards;}
    @keyframes showContent{to{opacity:1;}}
  </style></head><body>
  
  <div id="intro">
    ${logoData?`<img src="${logoData}">`:`<div style="font-family:'Dancing Script',cursive;font-size:28px;color:#7a3b6f;">Creazioni D'Arte Eleonora</div>`}
  </div>

  <div id="content">
  ${logoData?`<div class="logoBox"><img src="${logoData}"></div>`:`<div class="logoBox">Logo</div>`}
  <h1 style="font-family:'Dancing Script',cursive;color:#7a3b6f;text-align:center">Creazioni D'Arte Eleonora</h1>

  <input id="clienteNome" placeholder="Nome cliente" style="width:60%;padding:8px;border:1px solid #ccc;border-radius:8px;display:block;margin:10px auto;text-align:center;font-weight:600;color:#7a3b6f;">

  ${sections.map(sec=>`<section><div class="head"><h3 style="margin:0;font-family:'Dancing Script',cursive;color:#7a3b6f">${sec.name}</h3><span>‚ñº</span></div><div class="cards">
  ${sec.items.map(it=>`<div style="background:#fff;padding:6px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.05)">
  <img src="${it.img}"><div style="font-weight:700;color:#c64d6f">${it.code}</div><div>${it.note||''}</div>
  <div><label><input type="checkbox"> üíï</label> <input type="number" min="0" value="${it.qty}" style="width:60px"></div></div>`).join('')}
  </div></section>`).join('')}
  
  <button class="btn" id="sendWhats">üì© Invia selezione su WhatsApp</button>
  <button class="btn" id="sendEmail">üìß Invia via Email</button>
  </div>

  <script>
  document.querySelectorAll('.head').forEach(h=>h.addEventListener('click',()=>h.parentElement.classList.toggle('open')));
  function genMsg(){
    const nome=document.getElementById('clienteNome').value.trim();
    let msg='Ordine'+(nome?' di '+nome:'')+'%0A%0A';
    document.querySelectorAll('section').forEach(sec=>{
      sec.querySelectorAll('.cards > div').forEach(card=>{
        const chk=card.querySelector('input[type=checkbox]');
        if(chk.checked){
          const code=card.querySelector('div:nth-child(2)').innerText;
          const note=card.querySelector('div:nth-child(3)').innerText;
          const qty=card.querySelector('input[type=number]').value;
          msg+=code+' ‚Äì '+note+' (x'+qty+')%0A';
        }
      });
    });
    return msg;
  }
  document.getElementById('sendWhats').onclick=()=>{
    const m=genMsg();
    window.open('https://wa.me/?text='+m,'_blank');
  };
  document.getElementById('sendEmail').onclick=()=>{
    const m=genMsg();
    window.location.href='mailto:${email}?subject=Ordine Creazioni D\\'Arte Eleonora&body='+m.replace(/%0A/g,'%0D%0A');
  };
  <\/script></body></html>`;

  const blob=new Blob([clienteHtml],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='catalogo_cliente.html';
  a.click();
};

load();render();
</script>
</body>
</html>