<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Creazioni D'Arte Eleonora ‚Äì Catalogo</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#fdf5f9;
  --bg2:#f3e7ff;
  --accent1:#f7d1e0;
  --accent2:#c9b7ff;
  --text:#3b3b3b;
}
*{box-sizing:border-box;transition:all .25s ease}
html,body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  padding:16px;
  touch-action:manipulation;
  overscroll-behavior:none;
}
.wrap{max-width:1100px;margin:auto;animation:fadein .6s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
header{display:flex;align-items:center;gap:16px;margin-bottom:20px;}
.logo-preview{
  width:88px;height:88px;border-radius:16px;overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,0.1);
  display:flex;align-items:center;justify-content:center;
  background:#f7f3ff;color:#aaa;font-weight:600;font-size:14px;
  opacity:0;transform:scale(0.9);
}
.logo-preview.show{
  animation:logoEnter .8s ease forwards;
}
@keyframes logoEnter{
  from{opacity:0;transform:scale(0.8) rotate(-3deg);}
  to{opacity:1;transform:scale(1) rotate(0);}
}
.logo-preview img{width:100%;height:100%;object-fit:contain;}
.title{font-family:'Dancing Script',cursive;font-size:30px;color:#7a3b6f;}
.subtitle{color:#6b6b6b;font-size:13px;}
.btn{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,var(--accent2),var(--accent1));
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn:hover{box-shadow:0 0 10px rgba(247,209,224,0.8);}
.btn-ghost{
  padding:8px 14px;border-radius:12px;border:1px dashed rgba(0,0,0,0.1);
  background:#fff;cursor:pointer;
}
.btn-import{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,#90EE90,#32CD32);
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn-import:hover{box-shadow:0 0 10px rgba(144,238,144,0.8);}
.btn-export{
  padding:8px 14px;border-radius:12px;border:0;
  background:linear-gradient(135deg,#FFD700,#FFA500);
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.btn-export:hover{box-shadow:0 0 10px rgba(255,215,0,0.8);}
.panel{
  background:#fff;border-radius:16px;padding:14px;margin-bottom:14px;
  box-shadow:0 4px 18px rgba(0,0,0,0.08);
}
.main{margin-top:10px;}
.section{
  margin-bottom:10px;border-radius:16px;overflow:hidden;
  border:1px solid rgba(0,0,0,0.06);
  background:#fff;
}
.section.dragging{opacity:0.6;}
.section .head{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 14px;background:linear-gradient(90deg,rgba(201,183,255,0.12),rgba(247,209,224,0.12));
  cursor:grab;
}
.section .head h3{
  margin:0;font-family:'Dancing Script',cursive;font-size:20px;color:#7a3b6f;display:flex;align-items:center;gap:8px;
}
.section .head button.del{background:none;border:none;color:#c64d6f;cursor:pointer;font-size:18px;}
.cards{
  padding:14px;display:none;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:12px;background:#fff;
}
.section.open .cards{display:grid;animation:fadecards .3s ease;}
@keyframes fadecards{from{opacity:0;transform:translateY(-5px);}to{opacity:1;transform:translateY(0);}}
.card{
  background:#fff;border-radius:12px;padding:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.05);
  display:flex;flex-direction:column;gap:8px;
}
.card:hover{box-shadow:0 0 8px rgba(255,175,200,0.5);}
.thumb{width:100%;height:200px;border-radius:10px;overflow:hidden;background:#fafafa;display:flex;align-items:center;justify-content:center;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.code{font-weight:700;color:#c64d6f;font-size:14px;}
.note{font-size:13px;color:#6b6b6b;}
.controls{display:flex;gap:8px;align-items:center;justify-content:space-between;}
.qty{width:60px;padding:6px;border-radius:6px;border:1px solid #ccc;text-align:center;}
.fav{display:flex;align-items:center;gap:5px;}
.import-export-section{
  background:#fff3cd;
  border:2px dashed #ffc107;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.import-export-section h4{
  margin:0 0 10px 0;
  color:#856404;
  font-family:'Dancing Script',cursive;
  font-size:20px;
}
.button-group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}
.loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10000;
  color:#fff;
  font-size:18px;
  flex-direction:column;
  gap:10px;
}
.loading-spinner{
  width:50px;
  height:50px;
  border:5px solid rgba(255,255,255,0.3);
  border-top:5px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo-preview" id="logoBox"><span>Logo</span><img id="logoImg" alt="logo" style="display:none;"></div>
  <div>
    <div class="title">Creazioni D'Arte Eleonora</div>
    <div class="subtitle">Catalogo Lavori Personalizzati</div>
  </div>
</header>

<script>
window.addEventListener("DOMContentLoaded",()=>{
  const logoBox=document.getElementById("logoBox");
  requestAnimationFrame(()=>logoBox.classList.add("show"));
});
</script>

<!-- üÜï SEZIONE IMPORT/EXPORT DATABASE -->
<div class="import-export-section">
  <h4>üíæ Import/Export Database (IndexedDB - Illimitato)</h4>
  <div style="font-size:13px;color:#856404;margin-bottom:10px;">
    Esporta tutto il database (foto incluse) per trasferirlo su altri dispositivi o come backup.
  </div>
  <div class="button-group">
    <button class="btn-export" id="exportDatabase">üì¶ Download Database</button>
    <button class="btn-export" id="sendTelegram">üì± Invia su Telegram</button>
    <label class="btn-import">
      üì• Importa Database
      <input id="importDatabase" type="file" accept=".json,application/json" style="display:none;">
    </label>
  </div>
  <div style="font-size:12px;color:#856404;margin-top:8px;">
    üí° <strong>Consiglio:</strong> Usa Telegram per trasferire il database tra telefono e PC. Invialo a "Messaggi Salvati"!
  </div>
</div>

<div class="panel">
  <label class="btn">Carica logo<input id="logoInput" type="file" accept="image/*" style="display:none;"></label>
  <input id="newSectionName" placeholder="Nuova sezione (es. Natale)" style="padding:8px;border-radius:8px;border:1px solid #ccc;margin:6px 0;width:60%">
  <button class="btn" id="addSectionBtn">Aggiungi sezione</button>
  <button class="btn-ghost" id="resetStorage">üîÑ Reset catalogo</button>
</div>

<div class="panel">
  <input id="emailDest" placeholder="Email destinatario ordini" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:6px;">
  <button class="btn-ghost" id="exportHtml">üíæ Esporta catalogo (.html)</button>
  <div style="margin-top:8px;font-weight:600;color:#7a3b6f;">Totale lavori: <span id="totaleLavori">0</span></div>
</div>

<main class="main" id="mainContent"></main>
</div>

<script>
let sections=[],logoData=null;
const main=document.getElementById('mainContent');

// üÜï INDEXEDDB MANAGER
const DB_NAME = 'EleonoraCatalogo';
const DB_VERSION = 1;
let db = null;

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (e) => {
      const database = e.target.result;
      
      // Store per le sezioni
      if (!database.objectStoreNames.contains('sections')) {
        database.createObjectStore('sections', { keyPath: 'id' });
      }
      
      // Store per i metadati (logo, email, etc)
      if (!database.objectStoreNames.contains('metadata')) {
        database.createObjectStore('metadata', { keyPath: 'key' });
      }
    };
  });
}

async function saveDB() {
  if (!db) await initDB();
  
  const tx = db.transaction(['sections', 'metadata'], 'readwrite');
  const sectionsStore = tx.objectStore('sections');
  const metaStore = tx.objectStore('metadata');
  
  // Cancella tutto prima
  await sectionsStore.clear();
  
  // Salva sezioni
  for (const sec of sections) {
    await sectionsStore.put(sec);
  }
  
  // Salva metadata
  await metaStore.put({ key: 'logo', value: logoData });
  await metaStore.put({ key: 'email', value: document.getElementById('emailDest').value });
  
  return tx.complete;
}

async function loadDB() {
  if (!db) await initDB();
  
  const tx = db.transaction(['sections', 'metadata'], 'readonly');
  const sectionsStore = tx.objectStore('sections');
  const metaStore = tx.objectStore('metadata');
  
  // Carica sezioni
  const allSections = await sectionsStore.getAll();
  if (allSections.length > 0) {
    sections = allSections;
  } else {
    sections = [{id: uid('sec'), name: 'Natale', items: []}];
  }
  
  // Carica logo
  const logoMeta = await metaStore.get('logo');
  if (logoMeta && logoMeta.value) {
    logoData = logoMeta.value;
    document.getElementById('logoImg').src = logoData;
    document.getElementById('logoImg').style.display = 'block';
    document.querySelector('#logoBox span').style.display = 'none';
  }
  
  // Carica email
  const emailMeta = await metaStore.get('email');
  if (emailMeta && emailMeta.value) {
    document.getElementById('emailDest').value = emailMeta.value;
  }
}

function showLoading(text = 'Caricamento...') {
  const loading = document.createElement('div');
  loading.className = 'loading';
  loading.id = 'loadingOverlay';
  loading.innerHTML = `<div class="loading-spinner"></div><div>${text}</div>`;
  document.body.appendChild(loading);
}

function hideLoading() {
  const loading = document.getElementById('loadingOverlay');
  if (loading) loading.remove();
}

function uid(p='id'){return p+'_'+Math.floor(Math.random()*1e9).toString(36);}

function updateTotal(){
  let t=0;
  sections.forEach(s=>t+=s.items.length);
  document.getElementById('totaleLavori').textContent=t;
}

function nextCode(){
  let max=0;
  sections.forEach(s=>s.items.forEach(i=>{
    const m=i.code.match(/LAV0*([0-9]+)/);
    if(m){
      const n=+m[1];
      if(n>max)max=n;
    }
  }));
  return max+1;
}

function addPhoto(sec){
  const inp=document.createElement('input');
  inp.type='file';inp.multiple=true;inp.accept='image/*';
  inp.onchange=e=>{
    const files=Array.from(e.target.files);
    showLoading(`Caricamento ${files.length} foto...`);
    
    let processed = 0;
    files.forEach(file=>{
      const r=new FileReader();
      r.onload=ev=>{
        const img=new Image();
        img.onload=async ()=>{
          const max=800;let w=img.width,h=img.height;
          if(w>h&&w>max){h=h*max/w;w=max;}
          else if(h>max){w=w*max/h;h=max;}
          const c=document.createElement('canvas');
          c.width=w;c.height=h;
          const ctx=c.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          const data=c.toDataURL('image/jpeg',0.8);
          sec.items.push({
            id:uid('it'),
            img:data,
            code:'LAV'+String(nextCode()).padStart(3,'0'),
            note:'',
            qty:0,
            fav:false
          });
          
          processed++;
          if (processed === files.length) {
            await saveDB();
            render();
            hideLoading();
          }
        };
        img.src=ev.target.result;
      };
      r.readAsDataURL(file);
    });
  };
  inp.click();
}

function render(){
  main.innerHTML='';
  sections.forEach(sec=>{
    const s=document.createElement('div');s.className='section';s.draggable=true;
    s.innerHTML=`
      <div class="head">
        <h3>${sec.name} <button class="del" title="Elimina sezione">üóëÔ∏è</button></h3>
        <span>‚ñº</span>
        <button class="btn-ghost" data-id="${sec.id}">Aggiungi foto</button>
      </div>
      <div class="cards"></div>`;
    const grid=s.querySelector('.cards');

    sec.items.forEach(it=>{
      const c=document.createElement('div');
      c.className='card';
      c.innerHTML=`
        <div class="thumb"><img src="${it.img}"></div>
        <div class="code">${it.code}</div>
        <div class="note" contenteditable="true">${it.note||'Nota...'}</div>
        <div class="controls">
          <label class="fav"><input type="checkbox" ${it.fav?'checked':''}> üíï</label>
          <input type="number" value="${it.qty}" min="0" class="qty">
        </div>
        <button class="btn-ghost del-photo">üóëÔ∏è Elimina foto</button>
      `;
      grid.appendChild(c);

      c.querySelector('.note').oninput=async e=>{it.note=e.target.textContent;await saveDB();};
      c.querySelector('input[type=checkbox]').onchange=async e=>{it.fav=e.target.checked;await saveDB();};
      c.querySelector('.qty').onchange=async e=>{it.qty=parseInt(e.target.value)||0;await saveDB();};

      c.querySelector('.del-photo').onclick=async ()=>{
        if(confirm('Vuoi eliminare questa foto?')){
          sec.items = sec.items.filter(x=>x.id!==it.id);
          await saveDB();
          render();
        }
      };
    });

    s.querySelector('.head').addEventListener('click',e=>{
      if(e.target.tagName==='BUTTON' && !e.target.classList.contains('del'))return;
      s.classList.toggle('open');
    });

    s.querySelector('.btn-ghost').onclick=()=>addPhoto(sec);

    s.querySelector('.del').onclick=async ()=>{
      if(confirm('Vuoi eliminare la sezione "'+sec.name+'"?')){
        sections=sections.filter(x=>x.id!==sec.id);
        await saveDB();
        render();
      }
    };

    s.addEventListener('dragstart',()=>s.classList.add('dragging'));
    s.addEventListener('dragend',async ()=>{s.classList.remove('dragging');await saveDB();});
    main.appendChild(s);
  });

  updateTotal();
  enableDrag();
}

function enableDrag(){
  main.addEventListener('dragover',e=>{
    e.preventDefault();
    const dragging=document.querySelector('.dragging');
    const after=getDragAfterElement(main,e.clientY);
    if(after==null) main.appendChild(dragging); 
    else main.insertBefore(dragging,after);
    sections=[...main.querySelectorAll('.section')].map(s=>{
      const id=s.querySelector('.btn-ghost').dataset.id;
      return sections.find(x=>x.id===id);
    });
  });
}

function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.section:not(.dragging)')];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset){
      return {offset:offset,element:child};
    } else return closest;
  },{offset:Number.NEGATIVE_INFINITY}).element;
}

// üÜï ESPORTA DATABASE (Download)
document.getElementById('exportDatabase').onclick=async ()=>{
  try {
    showLoading('Esportazione database...');
    
    const database = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      logo: logoData,
      email: document.getElementById('emailDest').value,
      sections: sections
    };
    
    const dataStr = JSON.stringify(database);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `catalogo_eleonora_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
    
    hideLoading();
    alert('‚úÖ Database esportato! Controlla la cartella Download.');
  } catch(err) {
    hideLoading();
    alert('‚ùå Errore durante l\'esportazione:\n' + err.message);
    console.error(err);
  }
};

// üÜï INVIA SU TELEGRAM
document.getElementById('sendTelegram').onclick=async ()=>{
  try {
    showLoading('Preparazione database per Telegram...');
    
    const database = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      logo: logoData,
      email: document.getElementById('emailDest').value,
      sections: sections
    };
    
    const dataStr = JSON.stringify(database);
    const totalPhotos = sections.reduce((tot,s)=>tot+s.items.length,0);
    
    hideLoading();
    
    // Prova prima con Web Share API (funziona meglio su mobile moderni)
    if (navigator.share && navigator.canShare) {
      try {
        const blob = new Blob([dataStr], {type: 'application/json'});
        const fileName = `catalogo_eleonora_${new Date().toISOString().split('T')[0]}.json`;
        const file = new File([blob], fileName, {type: 'application/json'});
        
        if (navigator.canShare({files: [file]})) {
          await navigator.share({
            title: 'Database Catalogo Eleonora',
            text: `üì∏ Database con ${totalPhotos} foto\nüìÖ ${new Date().toLocaleDateString('it-IT')}`,
            files: [file]
          });
          
          alert('‚úÖ Perfetto! Ora:\n\n1Ô∏è‚É£ Seleziona TELEGRAM\n2Ô∏è‚É£ Cerca "Messaggi Salvati"\n3Ô∏è‚É£ Invia il file\n4Ô∏è‚É£ Sul PC apri Telegram e scaricalo');
          return;
        }
      } catch(e) {
        console.log('Web Share non disponibile, uso metodo alternativo');
      }
    }
    
    // Metodo alternativo: crea file e apri Telegram Web
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `catalogo_eleonora_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Prepara messaggio per Telegram
    const message = `üì¶ Database Catalogo Eleonora
üì∏ Foto: ${totalPhotos}
üìÖ Data: ${new Date().toLocaleDateString('it-IT')}
üíæ File scaricato! Ora caricalo su Telegram.`;
    
    setTimeout(() => {
      URL.revokeObjectURL(url);
      
      const choice = confirm(
        '‚úÖ File scaricato!\n\n' +
        'Vuoi aprire Telegram Web per caricarlo?\n\n' +
        '‚Ä¢ OK = Apri Telegram Web\n' +
        '‚Ä¢ Annulla = Aprilo manualmente dall\'app'
      );
      
      if (choice) {
        // Apri Telegram Web
        window.open('https://web.telegram.org', '_blank');
        
        setTimeout(() => {
          alert(
            'üì± ISTRUZIONI:\n\n' +
            '1Ô∏è‚É£ Accedi a Telegram Web\n' +
            '2Ô∏è‚É£ Cerca "Messaggi Salvati" (icona bookmark)\n' +
            '3Ô∏è‚É£ Clicca sulla graffetta üìé\n' +
            '4Ô∏è‚É£ Carica il file JSON appena scaricato\n' +
            '5Ô∏è‚É£ Sul PC apri Telegram e scaricalo\n' +
            '6Ô∏è‚É£ Importalo nel generatore con "üì• Importa Database"'
          );
        }, 2000);
      } else {
        alert(
          'üì± ISTRUZIONI:\n\n' +
          '1Ô∏è‚É£ Apri Telegram sul telefono\n' +
          '2Ô∏è‚É£ Vai in "Messaggi Salvati"\n' +
          '3Ô∏è‚É£ Clicca sulla graffetta üìé\n' +
          '4Ô∏è‚É£ Seleziona "File"\n' +
          '5Ô∏è‚É£ Cerca e carica il file JSON dalla cartella Download\n' +
          '6Ô∏è‚É£ Sul PC apri Telegram e scaricalo\n' +
          '7Ô∏è‚É£ Importalo nel generatore con "üì• Importa Database"'
        );
      }
    }, 500);
    
  } catch(err) {
    hideLoading();
    alert('‚ùå Errore: ' + err.message);
    console.error(err);
  }
};

function showTextArea(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;height:80%;z-index:10000;padding:10px;font-size:12px;';
  document.body.appendChild(ta);
  ta.select();
  
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;';
  document.body.appendChild(overlay);
  
  alert('üìã Seleziona tutto (tieni premuto ‚Üí "Seleziona tutto"), poi copia e chiudi.\n\nIncollalo in Note e salvalo come "database.json"');
  
  overlay.onclick = () => {
    document.body.removeChild(ta);
    document.body.removeChild(overlay);
  };
}

// üÜï IMPORTA DATABASE
document.getElementById('importDatabase').onchange=async e=>{
  const file = e.target.files[0];
  if(!file) return;
  
  if(!confirm('‚ö†Ô∏è ATTENZIONE: L\'importazione sostituir√† tutti i dati attuali. Continuare?')) {
    e.target.value = '';
    return;
  }
  
  showLoading('Importazione database...');
  
  const reader = new FileReader();
  reader.onload = async ev => {
    try {
      const database = JSON.parse(ev.target.result);
      
      if(!database.sections || !Array.isArray(database.sections)) {
        throw new Error('File non valido');
      }
      
      // Importa tutto
      sections = database.sections;
      logoData = database.logo || null;
      
      // Aggiorna logo
      if(logoData) {
        document.getElementById('logoImg').src = logoData;
        document.getElementById('logoImg').style.display = 'block';
        document.querySelector('#logoBox span').style.display = 'none';
      } else {
        document.getElementById('logoImg').style.display = 'none';
        document.querySelector('#logoBox span').style.display = 'block';
      }
      
      if(database.email) {
        document.getElementById('emailDest').value = database.email;
      }
      
      // Salva in IndexedDB
      await saveDB();
      render();
      
      hideLoading();
      
      alert('‚úÖ Database importato!\n\n' + 
            `üì¶ Sezioni: ${sections.length}\n` +
            `üì∏ Foto totali: ${sections.reduce((tot,s)=>tot+s.items.length,0)}\n` +
            `üìÖ Esportato: ${new Date(database.exportDate).toLocaleDateString('it-IT')}`);
      
    } catch(err) {
      hideLoading();
      alert('‚ùå Errore importazione:\n' + err.message);
      console.error(err);
    }
    
    e.target.value = '';
  };
  
  reader.readAsText(file);
};

document.getElementById('addSectionBtn').onclick=async ()=>{
  const n=document.getElementById('newSectionName').value.trim();
  if(!n)return alert('Scrivi un nome sezione!');
  sections.push({id:uid('sec'),name:n,items:[]});
  document.getElementById('newSectionName').value='';
  await saveDB();
  render();
};

document.getElementById('newSectionName').addEventListener('keypress', async e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('addSectionBtn').click();
  }
});

document.getElementById('logoInput').onchange=async e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=async a=>{
    logoData=a.target.result;
    const img=document.getElementById('logoImg');
    img.src=logoData;
    img.style.display='block';
    document.querySelector('#logoBox span').style.display='none';
    await saveDB();
  };
  r.readAsDataURL(f);
};

document.getElementById('resetStorage').onclick=async ()=>{
  if(confirm('Eliminare tutto?')){
    if (db) {
      indexedDB.deleteDatabase(DB_NAME);
    }
    location.reload();
  }
};

document.getElementById('exportHtml').onclick=()=>{
  const email=document.getElementById('emailDest').value||'';
  const clienteHtml=`<!DOCTYPE html><html lang="it"><head><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Catalogo Cliente</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,Arial;background:linear-gradient(135deg,#fdf5f9,#f3e7ff);color:#333;padding:10px;overflow-x:hidden;overflow-y:auto;}
    section{border:1px solid #eee;border-radius:12px;margin-bottom:10px;overflow:hidden;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,0.05);}
    .head{background:rgba(201,183,255,0.15);padding:8px;display:flex;justify-content:space-between;cursor:pointer;}
    .cards{display:none;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;padding:10px;}
    section.open .cards{display:grid;}
    img{max-width:100%;border-radius:10px;}
    .btn{padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(135deg,#c9b7ff,#f7d1e0);color:#fff;font-weight:600;cursor:pointer;display:block;margin:10px auto;}
    .logoBox{width:120px;height:120px;margin:0 auto 10px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:#f7f3ff;}
    .logoBox img{max-width:100%;max-height:100%;object-fit:contain;}
    #intro{
      position:fixed;inset:0;
      background:linear-gradient(135deg,#fdf5f9,#f3e7ff);
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;z-index:9999;
      animation:fadeOut 1s ease 2.5s forwards;
    }
    #intro img{
      width:280px;
      height:280px;
      object-fit:contain;
      opacity:0;
      animation:logoIn 1.2s ease forwards;